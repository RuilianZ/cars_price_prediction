---
title: "Used Cars Price Prediction - Report"
author: "Roxy Zhang"
date: "3/25/2022"
output:
  pdf_document:
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
---

\newpage

```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(caret)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .7,
  out.width = "95%"
)

theme_set(theme_minimal() + theme(legend.position = 'bottom'))
```


# Introduction

Since the market of used cars is growing, there is an increasing need of the information of used cars prices. Therefore, we want to build a model predicting the price using attributes of the car as predictors, and thus provide information for the potential buyers for decision making.  

Our data is from [Kaggle](https://www.kaggle.com/code/kuanghiu/used-cars-price-prediction). This dataset contains 22 (1998-2019) years of used cars information. There are 5872 rows and 11 predictors, among which 5 are numeric and 6 are categorical.  


# Data Cleaning

For better illustration, we transformed the original unit (100000 Indian Rupee) of response variable **price** to USD, using the exchange rate of 100000 Indian Rupee equals to 1309.75 USD on March 21, 2022. For numeric variables with unit, the units are deleted for model-building. We also delete the car model from the original `name` variable, keeping only the brand name, since the model can be greatly explained by the predictors we are using. The type `Fourth` in owner_type is actually Fourth and above. For analysis completeness, we dropped NA values. We also filtered out a row containing an extremely large value of kilometers_driven.  


Below are the variable used:

**name**: The brand of the car.  
**location**: The location in which the car is being sold or is available for purchase.  
**year**: The year or edition of the model.  
**kilometers_driven**: The total kilometres driven in the car by the previous owner(s) in KM.  
**fuel_type**: The type of fuel used by the car.  
**transmission**: The type of transmission used by the car.  
**owner_type**: Whether the ownership is Firsthand, Second hand or other.  
**mileage**: The standard mileage offered by the car company in kmpl or km/kg.  
**engine**: The displacement volume of the engine in cc.  
**power**: The maximum power of the engine in bhp.  
**seats**: The number of seats in the car.  
**price**: The price of the used car in US Dollar. 

```{r data cleaning, include = FALSE}
# re-level owner type
ord_owner_type = c("First", "Second", "Third", "Fourth")

# data import and cleaning
car = read_csv("data.csv") %>% 
  janitor::clean_names() %>% 
  select(- c(x1, new_price)) %>% 
  drop_na() %>% 
  filter(power != "null bhp") %>% 
  mutate(
    price = round(price * 1309.57, 0),
    name = gsub(" .*$", "", name),
    engine = gsub(" CC", "", engine),
    mileage = gsub(" .*$", "", mileage),
    power = gsub(" bhp", "", power),
    owner_type = gsub(" & Above", "", owner_type)) %>% 
  mutate(
    engine = as.numeric(engine),
    mileage = as.numeric(mileage),
    power = as.numeric(power),
    name = as.factor(name),
    location = as.factor(location),
    fuel_type = as.factor(fuel_type),
    transmission = as.factor(transmission),
    owner_type = as.factor(owner_type),
    owner_type = fct_relevel(owner_type, ord_owner_type),
    seats = as.factor(seats)
  ) %>% 
  filter(kilometers_driven < 1000000) %>% 
  select(name, location, fuel_type, transmission, owner_type, seats, everything())

# abnormal value
car %>% 
  filter(kilometers_driven > 1000000) %>% 
  select(kilometers_driven) # 6500000
```

# Exploratory Data Analysis

```{r fig.asp = 0.4, echo=FALSE}
# visualization for numeric variable year
car %>% 
  ggplot(aes(x = year, y = log(price))) + 
  geom_bar(stat = "identity", fill = "blue")
```

First, we plot the price against year. For better scaling, the price is log-transformed. There is an increasing trend of price from 1998-2014, while the price goes down rapidly since 2015.

```{r fig.asp = 1.0, echo=FALSE}
# visualization for categorical variables
theme_set(
  theme_minimal() +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  theme(legend.position = "none"))

p1 = car %>% 
  ggplot(aes(x = name, y = price, fill = name)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

p2 = car %>% 
  ggplot(aes(x = fuel_type, y = price, fill = fuel_type)) +
  geom_boxplot()

p3 = car %>% 
  ggplot(aes(x = transmission, y = price, fill = transmission)) +
  geom_boxplot()

p4 = car %>% 
  ggplot(aes(x = owner_type, y = price, fill = owner_type)) +
  geom_boxplot()

p5 = car %>% 
  ggplot(aes(x = seats, y = price, fill = seats)) +
  geom_boxplot()

(p2 + p3)/(p4 + p5)/(p1)
```

Then we look at the price distribution for 5 categorical predictors respectively. There are some interesting findings:  
* There are several attributes associated with higher price: fuel type diesel, automatic transmission, first-hand owner, and with 2 seats.  
* The price range for each brand varies a lot. For example, Lamborghini has a condensed price range slightly above 150k (which is not surprising), while the majority stays below 25k.


# Data Partitioning

We split the data into training data and testing data by the proportion of 0.8:0.2.


# Model Building

What predictor variables did you include?
What technique did you use? What assumptions, if any, are being made by using this technique?
If there were tuning parameters, how did you pick their values?
Discuss the training/test performance if you have a test data set.
Which variables play important roles in predicting the response?
What are the limitations of the models you used (if there are any)? Are the models flexible enough to capture the underlying truth?
...
 

# Conclusions

What were your findings? Are they what you expect? What insights into the data can you make?
